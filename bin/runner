#!/bin/ruby

require 'logger'
require_relative '../lib/power_station'

$logger = Logger.new($stdout)
$stdout.sync = true

# Start up servers
mqtt_server = PowerStation::MQTT::Server.new.start
metrics_server = PowerStation::MetricsServer.new(mqtt_server).start
api_server = PowerStation::ApiServer.new(mqtt_server, 3000).start

# Start up signal handlers
r, w = IO.pipe
main_thread = Thread.current
signal_handler = Thread.new do
  while (io = IO.select([r]))
    metrics_server.stop
    api_server.stop
    mqtt_server.stop
    break
  end
  main_thread.run # Wake up from sleep
end
%w[INT TERM].each { |s| Signal.trap(s) { w.puts(s) } }

# Sleep forever
sleep
